<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TikSepet | Ã–deme</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" type="image/x-icon" href="assets/favicon/favicon.ico" />
  </head>
  <body>
    <!-- YÃ¼kleniyor animasyonu -->
    <div id="loader">YÃ¼kleniyor...</div>

    <!-- Ãœst navigasyon -->
    <header>
      <nav class="navbar">
        <a href="index.html" class="logo">
          <img
            src="assets/images/logos/logo_light.png"
            alt="TikSepet"
            id="site-logo"
          />
        </a>

        <!-- MenÃ¼ baÄŸlantÄ±larÄ± -->
        <ul class="nav-links" id="navLinks">
          <li><a href="index.html">Anasayfa</a></li>
          <li><a href="products.html">ÃœrÃ¼nler</a></li>
          <li>
            <a href="cart.html">
              Sepet <span id="cart-count" class="cart-count">0</span>
            </a>
          </li>
          <li><a href="profile.html">Profil</a></li>
          <li><a href="admin.html">Admin</a></li>
          <li id="auth-area"></li>
        </ul>

        <!-- Tema ve hamburger birlikte -->
        <div class="nav-right">
          <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
          <div class="nav-toggle" onclick="toggleMenu()">
            <span></span><span></span><span></span>
          </div>
        </div>
      </nav>
    </header>

    <!-- Ana Ã¶deme formu -->
    <main class="checkout-container">
      <h1>Ã–deme SayfasÄ±</h1>
      <form id="checkout-form">
        <h2>Teslimat Bilgileri</h2>

        <!-- KullanÄ±cÄ± bilgileri alanlarÄ± -->
        <label>Ad *</label>
        <input type="text" id="first-name" required />
        <label>Soyad *</label>
        <input type="text" id="last-name" required />
        <label>Telefon *</label>
        <input type="tel" id="phone" required placeholder="05XX XXX XX XX" />
        <label>E-posta *</label>
        <input type="email" id="email" required />
        <label>Ä°l *</label>
        <input type="text" id="city" required />
        <label>Ä°lÃ§e *</label>
        <input type="text" id="district" required />
        <label>AÃ§Ä±k Adres *</label>
        <textarea id="address" rows="3" required></textarea>

        <!-- Ã–deme yÃ¶ntemi seÃ§imi -->
        <label for="payment-method">Ã–deme YÃ¶ntemi *</label>
        <select id="payment-method" required>
          <option value="">SeÃ§iniz</option>
          <option value="card">Kart ile Ã–deme</option>
          <option value="cash">KapÄ±da Ã–deme</option>
        </select>

        <!-- Kart bilgileri sadece kartla Ã¶deme seÃ§ilince gÃ¶rÃ¼nÃ¼r -->
        <div id="card-info" style="display: none; margin-top: 15px">
          <h3>Kart Bilgileri</h3>
          <label>Kart NumarasÄ± *</label>
          <input
            type="text"
            id="card-number"
            maxlength="19"
            placeholder="XXXX XXXX XXXX XXXX"
          />
          <label>Son Kullanma Tarihi *</label>
          <input type="text" id="expiry" placeholder="AA/YY" />
          <label>CVV *</label>
          <input type="text" id="cvv" maxlength="4" />
        </div>

        <button type="submit" class="complete-order-btn">
          SipariÅŸi Tamamla
        </button>
      </form>
    </main>

    <!-- SipariÅŸ Ã–zeti -->
    <section id="order-summary" class="order-summary" aria-live="polite">
      <h2>SipariÅŸ Ã–zeti</h2>
      <div id="summary-list"></div>
      <div class="summary-total">
        <span>Toplam:</span> <strong id="summary-total">â‚º0,00</strong>
      </div>
    </section>

    <!-- Footer -->
    <footer>
      <div class="footer-content">
        <img
          src="assets/images/logos/logo_light.png"
          alt="TikSepet Logo"
          id="footer-logo"
          class="footer-logo"
        />
        <p>&copy; 2025 TikSepet E-Ticaret Sitesi created by Hakan Onay</p>
      </div>
    </footer>

    <!-- JavaScript -->
    <script>
      // Loader
      window.addEventListener("load", () => {
        const loader = document.getElementById("loader");
        if (loader) loader.style.display = "none";
      });

      // Tema / MenÃ¼
      function toggleTheme() {
        document.body.classList.toggle("dark");
        const theme = document.body.classList.contains("dark")
          ? "dark"
          : "light";
        localStorage.setItem("theme", theme);
        updateLogo(theme);
        updateFooterLogo();
      }
      function toggleMenu() {
        document.getElementById("navLinks").classList.toggle("active");
      }
      function updateLogo(theme) {
        const logo = document.getElementById("site-logo");
        logo.src =
          theme === "dark"
            ? "assets/images/logos/logo_dark.png"
            : "assets/images/logos/logo_light.png";
      }
      function updateFooterLogo() {
        const logo = document.getElementById("footer-logo");
        logo.src = document.body.classList.contains("dark")
          ? "assets/images/logos/logo_dark.png"
          : "assets/images/logos/logo_light.png";
      }

      // Util
      const fmtTRY = (n) =>
        new Intl.NumberFormat("tr-TR", {
          style: "currency",
          currency: "TRY",
        }).format(n);
      const getCart = () => JSON.parse(localStorage.getItem("cart") || "[]");

      // Sepet rozeti
      function updateCartCount() {
        const cart = getCart();
        const el = document.getElementById("cart-count");
        if (el) el.textContent = cart.length;
      }

      // CanlÄ± rozet: localStorage deÄŸiÅŸimlerini yakala
      (function () {
        const _setItem = localStorage.setItem;
        const _removeItem = localStorage.removeItem;
        localStorage.setItem = function (key, value) {
          const oldVal = localStorage.getItem(key);
          _setItem.apply(this, arguments);
          if (key === "cart" && oldVal !== value)
            window.dispatchEvent(new Event("cart-changed"));
        };
        localStorage.removeItem = function (key) {
          _removeItem.apply(this, arguments);
          if (key === "cart") window.dispatchEvent(new Event("cart-changed"));
        };
        window.addEventListener("storage", (e) => {
          if (e.key === "cart") window.dispatchEvent(new Event("cart-changed"));
        });
      })();

      // Guard + tema + rozet
      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        if (savedTheme === "dark") document.body.classList.add("dark");
        updateLogo(savedTheme);
        updateFooterLogo();
        updateCartCount();

        // Sepet boÅŸsa ve/veya login yoksa engelle
        const cart = getCart();
        if (cart.length === 0) {
          alert("Sepetiniz boÅŸ. LÃ¼tfen Ã¼rÃ¼n ekleyin.");
          window.location.href = "products.html";
          return;
        }
        if (!localStorage.getItem("currentUserId")) {
          const ret = encodeURIComponent(location.pathname);
          window.location.href = `login.html?return=${ret}`;
          return;
        }

        // SipariÅŸ Ã¶zetini Ã§iz
        renderOrderSummary();

        // Form submit iÅŸlemi
        document
          .getElementById("checkout-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();

            // KullanÄ±cÄ± bilgilerini al
            const firstName = document
              .getElementById("first-name")
              .value.trim();
            const lastName = document.getElementById("last-name").value.trim();
            const phone = document.getElementById("phone").value.trim();
            const email = document.getElementById("email").value.trim();
            const city = document.getElementById("city").value.trim();
            const district = document.getElementById("district").value.trim();
            const address = document.getElementById("address").value.trim();
            const paymentMethod =
              document.getElementById("payment-method").value;

            // Zorunlu alan kontrolÃ¼
            if (
              !firstName ||
              !lastName ||
              !phone ||
              !email ||
              !city ||
              !district ||
              !address ||
              !paymentMethod
            ) {
              alert("LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.");
              return;
            }

            // Kart Ã¶demesi ise kart bilgilerini al ve kontrol et
            if (paymentMethod === "card") {
              const cardNumber = document
                .getElementById("card-number")
                .value.trim();
              const expiry = document.getElementById("expiry").value.trim();
              const cvv = document.getElementById("cvv").value.trim();

              if (!validateCard(cardNumber, expiry, cvv)) return;
            }

            // Sepetten toplam
            const cart = getCart();
            let total = 0;
            cart.forEach((item) => (total += item.price * item.quantity));

            // Yeni sipariÅŸ objesi
            const newOrder = {
              id: Date.now(),
              userId: localStorage.getItem("currentUserId"), // user baÄŸla
              name: firstName + " " + lastName,
              email,
              phone,
              address: `${city}/${district} - ${address}`,
              paymentMethod,
              items: cart,
              total,
              date: new Date().toISOString(),
            };

            // SipariÅŸi kaydet
            const orders = JSON.parse(localStorage.getItem("orders") || "[]");
            orders.push(newOrder);
            localStorage.setItem("orders", JSON.stringify(orders));
            localStorage.setItem("latestOrder", JSON.stringify(newOrder));

            // Sepeti temizle ve onaya git
            localStorage.removeItem("cart");
            window.location.href = "order-confirmation.html";
          });
      });

      // Ã–deme yÃ¶ntemi seÃ§ildikÃ§e kart bilgileri gÃ¶rÃ¼nmesini kontrol et
      document
        .getElementById("payment-method")
        .addEventListener("change", function () {
          const method = this.value;
          const cardInfo = document.getElementById("card-info");
          cardInfo.style.display = method === "card" ? "block" : "none";
        });

      // Maskeleme + doÄŸrulama
      function luhnCheck(num) {
        const s = (num || "").replace(/\s+/g, "");
        let sum = 0,
          alt = false;
        for (let i = s.length - 1; i >= 0; i--) {
          let n = parseInt(s[i], 10);
          if (alt) {
            n *= 2;
            if (n > 9) n -= 9;
          }
          sum += n;
          alt = !alt;
        }
        return sum % 10 === 0;
      }
      function validateCard(cardNumber, expiry, cvv) {
        const num = (cardNumber || "").replace(/\s/g, "");
        if (!num || num.length < 13 || !luhnCheck(num)) {
          alert("Kart numarasÄ± geÃ§ersiz gÃ¶rÃ¼nÃ¼yor. LÃ¼tfen kontrol edin.");
          return false;
        }
        const [mm, yy] = (expiry || "").split("/");
        const m = parseInt(mm, 10),
          y = parseInt("20" + (yy || ""), 10);
        if (!(m >= 1 && m <= 12) || !y) {
          alert("Son kullanma tarihi hatalÄ±. (AA/YY)");
          return false;
        }
        if (!(cvv.length === 3 || cvv.length === 4)) {
          alert("CVV 3 veya 4 haneli olmalÄ±.");
          return false;
        }
        return true;
      }
      document.addEventListener("DOMContentLoaded", () => {
        const phone = document.getElementById("phone");
        const cardNumber = document.getElementById("card-number");
        const expiry = document.getElementById("expiry");
        const cvv = document.getElementById("cvv");

        if (phone) {
          phone.addEventListener("input", () => {
            let v = phone.value.replace(/\D/g, "").slice(0, 11); // Sadece rakamlar ve max 11 hane

            if (v.length > 4) v = v.slice(0, 4) + " " + v.slice(4); // 4
            if (v.length > 8) v = v.slice(0, 8) + " " + v.slice(8); // 3
            if (v.length > 11) v = v.slice(0, 11) + " " + v.slice(11); // 2

            phone.value = v;
          });
        }
        if (cardNumber) {
          cardNumber.addEventListener("input", () => {
            let v = cardNumber.value.replace(/\D/g, "").slice(0, 19);
            cardNumber.value = v.replace(/(.{4})/g, "$1 ").trim();
          });
        }
        if (expiry) {
          expiry.addEventListener("input", () => {
            let v = expiry.value.replace(/\D/g, "").slice(0, 4);
            if (v.length >= 3) v = v.slice(0, 2) + "/" + v.slice(2);
            expiry.value = v;
          });
        }
        if (cvv) {
          cvv.addEventListener("input", () => {
            cvv.value = cvv.value.replace(/\D/g, "").slice(0, 4);
          });
        }
      });

      // SipariÅŸ Ã¶zetini Ã§iz
      function renderOrderSummary() {
        const listEl = document.getElementById("summary-list");
        const totalEl = document.getElementById("summary-total");
        if (!listEl || !totalEl) return;
        const cart = getCart();
        listEl.innerHTML = "";
        let total = 0;
        cart.forEach((item) => {
          const line = item.price * item.quantity;
          total += line;
          const row = document.createElement("div");
          row.className = "summary-item";
          row.innerHTML = `
            <div>${item.name}</div>
            <div class="summary-qty">x${item.quantity}</div>
            <div class="summary-line">${fmtTRY(line)}</div>
          `;
          listEl.appendChild(row);
        });
        totalEl.textContent = fmtTRY(total);
      }

      // CanlÄ± rozet
      window.addEventListener("cart-changed", updateCartCount);
    </script>

    <!-- Auth -->
    <script src="js/auth.js"></script>
  </body>
</html>
